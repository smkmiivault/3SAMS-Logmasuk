<!DOCTYPE html>
<html lang="ms">

<head>
    <link rel="icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="96x96" href="favicon-96x96.png">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="manifest" href="site.webmanifest">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3 SIDDIQ ELITE | AMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --apple-bg: #fbfbfd;
            --apple-glass: rgba(255, 255, 255, 0.75);
            --apple-border: rgba(0, 0, 0, 0.06);
            --accent-gold: #c5a059;
            --accent-gold-dark: #a88548;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--apple-bg);
            color: #1d1d1f;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* Glassmorphism Effect */
        .glass {
            background: var(--apple-glass);
            backdrop-filter: saturate(180%) blur(25px);
            -webkit-backdrop-filter: saturate(180%) blur(25px);
            border: 1px solid var(--apple-border);
        }

        /* Sidebar & Modals Transition */
        .slide-over {
            transition: transform 0.5s cubic-bezier(0.32, 0.72, 0, 1);
        }

        .modal-backdrop {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(8px);
            transition: all 0.4s ease;
        }

        /* Input Styling */
        .input-apple {
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .input-apple:focus {
            background: white;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 4px rgba(197, 160, 89, 0.12);
            outline: none;
        }

        /* Buttons */
        .btn-gold {
            background: linear-gradient(135deg, #C5A059 0%, #E2CFA4 100%);
            color: white;
            transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
        }

        .btn-gold:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(197, 160, 89, 0.4);
        }

        /* Animation */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-in {
            animation: slideUp 0.8s cubic-bezier(0.23, 1, 0.32, 1) forwards;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }
    </style>
</head>

<body style="display:none" class="min-h-screen">

    <!-- Navigation Bar -->
    <nav class="fixed top-0 w-full z-50 glass border-b border-apple-border px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-5">
            <button onclick="toggleMenu(true)" class="w-10 h-10 rounded-full hover:bg-black/5 flex items-center justify-center transition-all group">
                <i class="fa-solid fa-bars-staggered text-accent-gold group-hover:scale-110 transition-transform"></i>
            </button>
            <div class="flex items-center gap-3 border-l border-apple-border pl-5">
                <img src="https://i.postimg.cc/FsL0XknW/SMKMII-LGO-removebg-preview.png" alt="Logo SMK Membakut II" class="h-9 w-auto drop-shadow-sm" onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=SMKM2&background=C5A059&color=fff';">
                <div class="hidden sm:block">
                    <p class="text-[9px] font-black tracking-[0.25em] text-accent-gold uppercase leading-none mb-1">3 SIDDIQ ELITE</p>
                    <h1 class="text-sm font-extrabold tracking-tight leading-none">ATTENDANCE MANAGEMENT SYSTEM</h1>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <button id="exportPdf" class="px-4 py-2.5 rounded-2xl text-[10px] font-bold uppercase tracking-wider bg-white border border-apple-border text-red-500 hover:bg-red-50 transition-all flex items-center gap-2 shadow-sm">
                <i class="fa-solid fa-file-pdf"></i> PDF
            </button>
            <button onclick="openRegisterModal()" class="px-5 py-2.5 rounded-2xl text-[10px] font-bold uppercase tracking-wider btn-gold flex items-center gap-2 shadow-lg">
                <i class="fa-solid fa-plus"></i> Pelajar Baru
            </button>
        </div>
    </nav>

    <!-- Overlay Backdrop for Sidebar -->
    <div id="sidebarBackdrop" onclick="toggleMenu(false)" class="fixed inset-0 z-[55] modal-backdrop opacity-0 pointer-events-none"></div>

    <!-- Sidebar Menu -->
    <div id="sidebar" class="fixed inset-y-0 left-0 w-[300px] z-[60] glass slide-over -translate-x-full shadow-2xl flex flex-col border-r border-apple-border">
        <div class="p-8 flex flex-col h-full">
            <div class="flex justify-between items-center mb-10">
                <div class="flex items-center gap-3">
                    <img src="https://i.postimg.cc/FsL0XknW/SMKMII-LGO-removebg-preview.png" class="h-8 w-auto">
                    <span class="font-bold text-xs uppercase tracking-widest text-accent-gold">Menu Utama</span>
                </div>
                <button onclick="toggleMenu(false)" class="w-8 h-8 rounded-full hover:bg-black/5 flex items-center justify-center transition-all group">
                    <i class="fa-solid fa-xmark text-gray-400 group-hover:text-black transition-colors"></i>
                </button>
            </div>

            <div class="space-y-3 flex-1">
                <a href="/3SAMS/panelutama.html" class="flex items-center gap-4 p-4 rounded-2xl hover:bg-white/80 transition-all text-sm font-semibold group border border-transparent hover:border-apple-border">
                    <span class="w-10 h-10 rounded-xl bg-accent-gold/10 flex items-center justify-center group-hover:bg-accent-gold group-hover:text-white transition-all">
                        <i class="fa-solid fa-house"></i>
                    </span> Panel Utama
                </a>
                <a href="/3SAMS/uruspelajar.html" class="flex items-center gap-4 p-4 rounded-2xl bg-accent-gold/10 text-accent-gold border border-accent-gold/20 text-sm font-bold">
                    <span class="w-10 h-10 rounded-xl bg-accent-gold flex items-center justify-center text-white">
                        <i class="fa-solid fa-user-tie"></i>
                    </span> Urus Pelajar
                </a>
                <a href="/3SAMS/rekodhadir.html" class="flex items-center gap-4 p-4 rounded-2xl hover:bg-white/80 transition-all text-sm font-semibold group border border-transparent hover:border-apple-border">
                    <span class="w-10 h-10 rounded-xl bg-accent-gold/10 flex items-center justify-center group-hover:bg-accent-gold group-hover:text-white transition-all">
                        <i class="fa-solid fa-fingerprint"></i>
                    </span> Rekod Hadir
                </a>
                <a href="/3SAMS/analitik.html" class="flex items-center gap-4 p-4 rounded-2xl hover:bg-white/80 transition-all text-sm font-semibold group border border-transparent hover:border-apple-border">
                    <span class="w-10 h-10 rounded-xl bg-accent-gold/10 flex items-center justify-center group-hover:bg-accent-gold group-hover:text-white transition-all">
                        <i class="fa-solid fa-chart-pie"></i>
                    </span> Analitik
                </a>
            </div>

            <div class="pt-6 border-t border-apple-border">
                <button onclick="logout()" class="w-full flex items-center gap-4 p-4 rounded-2xl bg-red-50 text-red-500 text-sm font-bold hover:bg-red-500 hover:text-white transition-all shadow-sm">
                    <i class="fa-solid fa-power-off"></i> Log Keluar
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto pt-28 pb-20 px-6">
        <header class="mb-12 animate-in flex flex-col md:flex-row md:items-end justify-between gap-6">
            <div>
                <p class="text-[10px] font-black uppercase tracking-[0.3em] text-accent-gold mb-3">Sistem Pengurusan Pelajar</p>
                <h2 class="text-4xl font-extrabold tracking-tight mb-2">Pangkalan Data Pelajar</h2>
                <p class="text-gray-500 text-sm font-medium">Urus rekod digital dan akses bagi kelas 3 Siddiq.</p>
            </div>
            <div class="flex items-center gap-4 bg-white/50 border border-apple-border p-3 rounded-2xl">
                <div class="text-right border-r border-apple-border pr-4">
                    <p class="text-[9px] font-bold text-gray-400 uppercase">Jumlah Pelajar</p>
                    <p id="totalCount" class="text-lg font-black text-accent-gold">0</p>
                </div>
                <div class="pl-2">
                    <i class="fa-solid fa-users-viewfinder text-2xl text-accent-gold/30"></i>
                </div>
            </div>
        </header>

        <!-- Search Bar -->
        <div class="relative mb-10 animate-in" style="animation-delay: 0.1s">
            <i class="fa-solid fa-magnifying-glass absolute left-6 top-1/2 -translate-y-1/2 text-accent-gold/50 text-lg"></i>
            <input id="searchInput" placeholder="Cari menerusi Nama, IC atau ID Delima..." class="w-full glass border border-apple-border p-6 pl-16 rounded-[2rem] text-sm font-medium shadow-sm focus:ring-4 ring-accent-gold/10 outline-none transition-all placeholder:text-gray-400">
        </div>

        <!-- Table Container -->
        <div class="glass rounded-[3rem] overflow-hidden shadow-xl border border-white/60 animate-in" style="animation-delay: 0.2s">
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="bg-black/[0.03] border-b border-apple-border">
                            <th class="px-10 py-6 text-[10px] font-black uppercase tracking-[0.2em] text-gray-400">Profil Pelajar</th>
                            <th class="px-6 py-6 text-[10px] font-black uppercase tracking-[0.2em] text-gray-400">Identiti RFID</th>
                            <th class="px-6 py-6 text-[10px] font-black uppercase tracking-[0.2em] text-gray-400">Akses Digital</th>
                            <th class="px-10 py-6 text-[10px] font-black uppercase tracking-[0.2em] text-gray-400 text-right">Tindakan</th>
                        </tr>
                    </thead>
                    <tbody id="studentTable" class="divide-y divide-apple-border">
                        <!-- Content via JS -->
                    </tbody>
                </table>
            </div>
            <div id="emptyState" class="hidden py-40 text-center">
                <div class="w-24 h-24 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-6 text-gray-200 border border-apple-border">
                    <i class="fa-solid fa-user-slash text-3xl"></i>
                </div>
                <p class="text-gray-400 text-sm font-bold uppercase tracking-widest">Tiada rekod ditemui</p>
            </div>
        </div>
    </main>

    <!-- Slide-over Modal: Registration -->
    <div id="registerModal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 modal-backdrop opacity-0" onclick="closeRegisterModal()"></div>
        <div class="absolute inset-y-0 right-0 w-full max-w-md glass slide-over translate-x-full shadow-2xl flex flex-col border-l border-apple-border">
            <div class="p-10 flex-1 overflow-y-auto">
                <div class="flex justify-between items-center mb-12">
                    <div>
                        <p class="text-[9px] font-black tracking-[0.3em] text-accent-gold uppercase mb-1">Daftar Ahli</p>
                        <h2 class="text-2xl font-extrabold tracking-tight">Kemasukan Baru</h2>
                    </div>
                    <button onclick="closeRegisterModal()" class="w-10 h-10 rounded-full bg-black/5 flex items-center justify-center hover:bg-black/10 transition-all group">
                        <i class="fa-solid fa-xmark text-gray-500 group-hover:text-black"></i>
                    </button>
                </div>

                <div class="space-y-7">
                    <div>
                        <label class="text-[10px] font-black uppercase tracking-[0.2em] text-gray-400 ml-1 mb-3 block">Nama Penuh</label>
                        <input id="namaPenuh" placeholder="MOHD ALI BIN..." class="input-apple w-full p-5 rounded-2xl text-sm font-bold uppercase tracking-tight">
                    </div>

                    <div class="grid grid-cols-2 gap-5">
                        <div class="space-y-3">
                            <label class="text-[9px] font-black uppercase tracking-widest text-gray-400 ml-1">No. Kad Pengenalan</label>
                            <input id="ic" placeholder="12 Digit" maxlength="12" class="input-apple w-full p-4 rounded-2xl text-sm font-bold">
                        </div>
                        <div class="space-y-3">
                            <label class="text-[9px] font-black uppercase tracking-widest text-gray-400 ml-1">RFID UID</label>
                            <input id="uid" placeholder="10 Digit" maxlength="10" class="input-apple w-full p-4 rounded-2xl text-sm font-bold">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-5">
                        <div class="space-y-3">
                            <label class="text-[9px] font-black uppercase tracking-widest text-gray-400 ml-1">Jantina</label>
                            <select id="jantina" class="input-apple w-full p-4 rounded-2xl text-sm font-bold appearance-none">
                                <option value="">SILA PILIH</option>
                                <option value="LELAKI">LELAKI</option>
                                <option value="PEREMPUAN">PEREMPUAN</option>
                            </select>
                        </div>
                        <div class="space-y-3">
                            <label class="text-[9px] font-black uppercase tracking-widest text-gray-400 ml-1">PIN Keselamatan</label>
                            <input id="pin" placeholder="6 Digit" maxlength="6" class="input-apple w-full p-4 rounded-2xl text-sm font-bold text-center tracking-[0.5em]">
                        </div>
                    </div>

                    <div class="space-y-3">
                        <label class="text-[9px] font-black uppercase tracking-widest text-gray-400 ml-1">ID Delima (Email)</label>
                        <input id="delima" placeholder="m-12345678@moe-dl.edu.my" class="input-apple w-full p-4 rounded-2xl text-sm font-bold">
                    </div>

                    <div class="space-y-3">
                        <label class="text-[9px] font-black uppercase tracking-widest text-gray-400 ml-1">Pautan Foto Profil</label>
                        <input id="gambar" placeholder="https://..." class="input-apple w-full p-4 rounded-2xl text-sm font-bold">
                    </div>
                </div>
            </div>

            <div class="p-10 border-t border-apple-border bg-white/40">
                <button id="saveStudent" class="btn-gold w-full py-5 rounded-2xl font-black shadow-2xl tracking-[0.2em] uppercase text-xs">
                    Sahkan Pendaftaran
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Modal (Popup Center) -->
    <div id="editModal" class="fixed inset-0 z-[120] hidden flex items-center justify-center px-6">
        <div class="absolute inset-0 modal-backdrop opacity-0" onclick="closeEditModal()"></div>
        <div class="relative w-full max-w-lg glass p-10 rounded-[3rem] shadow-2xl border border-white animate-in transform opacity-0 scale-95 transition-all duration-300">
            <h2 class="text-2xl font-extrabold text-center mb-10 tracking-tight">Kemaskini Profil</h2>

            <div class="space-y-6">
                <div class="text-center p-6 bg-accent-gold/5 rounded-[2rem] border border-accent-gold/10">
                    <input id="eNama" disabled class="bg-transparent text-center font-black text-accent-gold text-xl w-full outline-none">
                    <p class="text-[9px] font-black text-gray-400 uppercase mt-2 tracking-widest">Identiti Terkunci</p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <input id="eIc" placeholder="IC" class="input-apple p-4 rounded-2xl text-sm font-bold">
                    <input id="eUid" placeholder="UID" class="input-apple p-4 rounded-2xl text-sm font-bold">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <select id="eJantina" class="input-apple p-4 rounded-2xl text-sm font-bold">
                        <option value="LELAKI">LELAKI</option>
                        <option value="PEREMPUAN">PEREMPUAN</option>
                    </select>
                    <input id="ePin" placeholder="PIN" class="input-apple p-4 rounded-2xl text-sm font-bold tracking-widest text-center">
                </div>

                <input id="eDelima" placeholder="ID DELIMA" class="input-apple w-full p-4 rounded-2xl text-sm font-bold">
                <input id="eGambar" placeholder="LINK GAMBAR" class="input-apple w-full p-4 rounded-2xl text-sm font-bold">

                <div class="flex gap-4 pt-6">
                    <button onclick="closeEditModal()" class="flex-1 py-5 text-[10px] font-black text-gray-400 uppercase tracking-widest hover:text-gray-600 transition-all">Batal</button>
                    <button id="updateStudent" class="flex-1 btn-gold py-5 rounded-[1.5rem] text-[10px] font-black shadow-xl uppercase tracking-widest">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="py-12 border-t border-gray-100 mt-8">
        <div class="max-w-[1400px] mx-auto px-8 flex flex-col md:flex-row justify-between items-center gap-6 text-center md:text-left">
            <div class="flex items-center gap-4">
                <img src="https://i.postimg.cc/FsL0XknW/SMKMII-LGO-removebg-preview.png" alt="Logo" class="h-6 grayscale opacity-30">
                <span class="text-[9px] font-bold tracking-[0.2em] text-gray-400 uppercase">3 SIDDIQ ELITE • AMS PLATINUM</span>
            </div>
            <p class="text-[9px] font-bold tracking-[0.1em] text-gray-300 uppercase">
                Designed in Membakut • © 2026
            </p>
        </div>
    </footer>

    <script type="module">
        import {
            initializeApp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            collection,
            doc,
            setDoc,
            updateDoc,
            onSnapshot
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBV5pPnUoZ5__ZDnpqutonr0xD8gI1Za7o",
            authDomain: "semii2go.firebaseapp.com",
            projectId: "semii2go",
            storageBucket: "semii2go.firebasestorage.app",
            messagingSenderId: "331630821647",
            appId: "1:331630821647:web:1fb749102956bc19607e7a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        onAuthStateChanged(auth, (user) => {
            if (!user) location.href = "/3SAMS/";
            else document.body.style.display = "block";
        });

        // UI Controls
        window.toggleMenu = (show) => {
            const side = document.getElementById('sidebar');
            const backdrop = document.getElementById('sidebarBackdrop');
            if (show) {
                side.classList.remove('-translate-x-full');
                backdrop.classList.remove('opacity-0', 'pointer-events-none');
            } else {
                side.classList.add('-translate-x-full');
                backdrop.classList.add('opacity-0', 'pointer-events-none');
            }
        };

        window.openRegisterModal = () => {
            const modal = document.getElementById('registerModal');
            const drawer = modal.querySelector('.slide-over');
            const backdrop = modal.querySelector('.modal-backdrop');
            modal.classList.remove('hidden');
            setTimeout(() => {
                drawer.classList.remove('translate-x-full');
                backdrop.classList.remove('opacity-0');
            }, 50);
        };

        window.closeRegisterModal = () => {
            const modal = document.getElementById('registerModal');
            const drawer = modal.querySelector('.slide-over');
            const backdrop = modal.querySelector('.modal-backdrop');
            drawer.classList.add('translate-x-full');
            backdrop.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 500);
        };

        window.openEdit = (p) => {
            editDocId = docIdFromName(p.namaPenuh);
            const modal = document.getElementById('editModal');
            const content = modal.querySelector('.relative');
            const backdrop = modal.querySelector('.modal-backdrop');

            document.getElementById('eNama').value = p.namaPenuh;
            document.getElementById('eIc').value = p.ic;
            document.getElementById('eUid').value = p.idPelajar;
            document.getElementById('eDelima').value = p.delima || "";
            document.getElementById('eJantina').value = p.jantina;
            document.getElementById('ePin').value = p.pin;
            document.getElementById('eGambar').value = p.gambar || "";

            modal.classList.remove("hidden");
            setTimeout(() => {
                content.classList.remove('opacity-0', 'scale-95');
                backdrop.classList.remove('opacity-0');
            }, 50);
        };

        window.closeEditModal = () => {
            const modal = document.getElementById('editModal');
            const content = modal.querySelector('.relative');
            const backdrop = modal.querySelector('.modal-backdrop');
            content.classList.add('opacity-0', 'scale-95');
            backdrop.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        };

        window.logout = async () => {
            await signOut(auth);
            window.location.href = "/3SAMS/";
        };

        // Student Logic
        let pelajar = [];
        let filtered = [];
        let editDocId = null;

        const clean = v => (typeof v === "string" ? v.trim() : "");
        const docIdFromName = (nama) => clean(nama).toUpperCase().replace(/[^A-Z0-9]+/g, "_");

        const saveBtn = document.getElementById('saveStudent');
        saveBtn.onclick = async () => {
            const data = {
                namaPenuh: clean(document.getElementById('namaPenuh').value),
                ic: clean(document.getElementById('ic').value),
                idPelajar: clean(document.getElementById('uid').value),
                delima: clean(document.getElementById('delima').value),
                jantina: clean(document.getElementById('jantina').value),
                pin: clean(document.getElementById('pin').value),
                gambar: clean(document.getElementById('gambar').value)
            };

            if (!data.namaPenuh || data.ic.length !== 12 || data.idPelajar.length !== 10 || data.pin.length !== 6 || !data.jantina) {
                alert("Maklumat tidak lengkap atau format salah.");
                return;
            }

            try {
                await setDoc(doc(db, "pelajar", docIdFromName(data.namaPenuh)), data);
                closeRegisterModal();
                ['namaPenuh', 'ic', 'uid', 'delima', 'pin', 'gambar'].forEach(id => document.getElementById(id).value = "");
                document.getElementById('jantina').value = "";
            } catch (e) {
                console.error(e);
            }
        };

        function initPelajar() {
            onSnapshot(collection(db, "pelajar"), snap => {
                pelajar = [];
                snap.forEach(d => {
                    const p = d.data();
                    if (p?.namaPenuh) pelajar.push(p);
                });
                document.getElementById('totalCount').innerText = pelajar.length;
                applySearch();
            });
        }

        document.getElementById('searchInput').oninput = applySearch;

        function applySearch() {
            const q = clean(document.getElementById('searchInput').value).toLowerCase();
            filtered = pelajar.filter(p => [p.namaPenuh, p.ic, p.idPelajar, p.delima].filter(Boolean).some(v => v.toLowerCase().includes(q)));
            renderTable();
        }

        function renderTable() {
            const table = document.getElementById('studentTable');
            const empty = document.getElementById('emptyState');
            table.innerHTML = "";

            if (filtered.length === 0) {
                empty.classList.remove("hidden");
                return;
            }
            empty.classList.add("hidden");

            filtered.sort((a, b) => a.namaPenuh.localeCompare(b.namaPenuh)).forEach(p => {
                const color = p.jantina === "LELAKI" ? 'bg-blue-500/10 text-blue-600' : 'bg-pink-500/10 text-pink-600';
                table.innerHTML += `
                    <tr class="hover:bg-black/[0.01] transition-all group border-b border-apple-border">
                        <td class="px-10 py-6">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-2xl border border-apple-border flex items-center justify-center overflow-hidden bg-white shadow-sm transition-transform group-hover:scale-105">
                                    ${p.gambar ? `<img src="${p.gambar}" class="w-full h-full object-cover">` : `<i class="fa-solid fa-user text-gray-200 text-xl"></i>`}
                                </div>
                                <div>
                                    <div class="font-bold text-[13px] tracking-tight uppercase">${p.namaPenuh}</div>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="px-2 py-0.5 rounded-lg text-[8px] font-black tracking-widest ${color}">${p.jantina}</span>
                                        <span class="text-[10px] text-gray-400 font-bold tracking-tighter">IC: ${p.ic}</span>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-6">
                            <code class="text-[10px] font-black bg-black/5 text-gray-500 px-3 py-1.5 rounded-xl border border-black/5 uppercase tracking-widest">${p.idPelajar}</code>
                        </td>
                        <td class="px-6 py-6">
                            <div class="text-[11px] text-gray-500 font-bold truncate max-w-[180px]">${p.delima || "N/A"}</div>
                        </td>
                        <td class="px-10 py-6 text-right">
                            <button class="bg-white border border-apple-border text-gray-500 px-5 py-2.5 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:border-accent-gold hover:text-accent-gold transition-all shadow-sm active:scale-95" 
                                onclick='openEdit(${JSON.stringify(p)})'>
                                Kemaskini
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        document.getElementById('updateStudent').onclick = async () => {
            const data = {
                ic: clean(document.getElementById('eIc').value),
                idPelajar: clean(document.getElementById('eUid').value),
                delima: clean(document.getElementById('eDelima').value),
                jantina: clean(document.getElementById('eJantina').value),
                pin: clean(document.getElementById('ePin').value),
                gambar: clean(document.getElementById('eGambar').value)
            };
            await updateDoc(doc(db, "pelajar", editDocId), data);
            closeEditModal();
        };

        // PDF Generation
        document.getElementById('exportPdf').onclick = () => {
            const {
                jsPDF
            } = window.jspdf;
            const pdf = new jsPDF();
            pdf.setFontSize(16);
            pdf.setTextColor(197, 160, 89);
            pdf.text("SMK MEMBAKUT II | 3 SIDDIQ ELITE", 14, 20);
            pdf.setFontSize(10);
            pdf.setTextColor(100);
            pdf.text("Laporan Maklumat Pelajar Terkini", 14, 27);

            const rows = filtered.map(p => [p.namaPenuh, p.ic, p.idPelajar, p.jantina, p.delima || "-"]);
            pdf.autoTable({
                startY: 35,
                head: [
                    ["NAMA", "IC", "RFID UID", "JANTINA", "ID DELIMA"]
                ],
                body: rows,
                headStyles: {
                    fillColor: [197, 160, 89],
                    fontSize: 9,
                    fontStyle: 'bold'
                },
                styles: {
                    fontSize: 8,
                    cellPadding: 4
                },
                alternateRowStyles: {
                    fillColor: [250, 250, 250]
                }
            });
            pdf.save("Pelajar3S.pdf");
        };
    </script>
</body>

</html>
